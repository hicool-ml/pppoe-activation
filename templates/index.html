<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PPPoEè´¦å·æ¿€æ´»</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }
    .activation-card {
      background: white;
      border-radius: 20px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
      padding: 40px;
      max-width: 500px;
      width: 100%;
    }
    @media (max-width: 576px) {
      .activation-card {
        padding: 25px;
        border-radius: 15px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
      }
      body {
        padding: 15px;
      }
    }
    .activation-card h1 {
      color: #333;
      font-size: 28px;
      font-weight: bold;
      text-align: center;
      margin-bottom: 30px;
    }
    @media (max-width: 576px) {
      .activation-card h1 {
        font-size: 24px;
        margin-bottom: 25px;
      }
    }
    .form-group {
      margin-bottom: 20px;
    }
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #555;
    }
    .form-control {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 14px;
      transition: border-color 0.3s;
      height: 44px;
      box-sizing: border-box;
    }
    @media (max-width: 576px) {
      .form-control {
        padding: 12px 15px;
        font-size: 16px;
        height: 48px;
      }
    }
    .form-control:focus {
      border-color: #667eea;
      outline: none;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    .btn-primary {
      width: 100%;
      padding: 12px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      height: 44px;
      box-sizing: border-box;
    }
    @media (max-width: 576px) {
      .btn-primary {
        padding: 14px;
        font-size: 18px;
        height: 48px;
      }
    }
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
    }
    .btn-primary:active {
      transform: translateY(0);
    }
    .btn-primary:disabled {
      background: #cccccc;
      cursor: not-allowed;
      opacity: 0.6;
      transform: none;
    }
    .result-box {
      margin-top: 30px;
      padding: 20px;
      border-radius: 10px;
      background: #f8f9fa;
    }
    @media (max-width: 576px) {
      .result-box {
        padding: 15px;
        margin-top: 25px;
      }
    }
    .result-box h2 {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 15px;
    }
    @media (max-width: 576px) {
      .result-box h2 {
        font-size: 16px;
        margin-bottom: 12px;
      }
    }
    .success {
      color: #28a745;
      font-weight: 600;
    }
    .error {
      color: #dc3545;
      font-weight: 600;
    }
    .info-text {
      font-size: 13px;
      margin-top: 5px;
      color: #666;
    }
    @media (max-width: 576px) {
      .info-text {
        font-size: 14px;
      }
    }
    .password-toggle {
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      cursor: pointer;
      font-size: 20px;
    }
    .hidden {
      display: none !important;
    }
    .radio-group {
      display: flex;
      align-items: center;
      gap: 20px;
    }
    .radio-group label {
      display: flex;
      align-items: center;
      margin: 0;
      font-weight: normal;
    }
    .radio-group input[type="radio"] {
      margin-right: 8px;
    }
    .toggle-log {
      color: #667eea;
      text-decoration: underline;
      cursor: pointer;
      font-size: 14px;
      margin-top: 10px;
      background: none;
      border: none;
      padding: 0;
    }
    .toggle-log:hover {
      color: #764ba2;
    }
    .log-box {
      margin-top: 15px;
      padding: 15px;
      background: #f0f0f0;
      border-radius: 8px;
      font-size: 12px;
      overflow-x: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
      max-height: 400px;
      overflow-y: auto;
    }
    .log-loading {
      text-align: center;
      padding: 20px;
      color: #667eea;
      font-weight: 500;
    }
  </style>
</head>
<body>
  <div class="activation-card">
    <h1>PPPoEè´¦å·æ¿€æ´»</h1>
    
    <!-- è¾“å…¥è¡¨å• -->
    <form id="pppoeForm">
      <!-- å§“å -->
      <div class="form-group">
        <label>å§“å</label>
        <input type="text" id="name" class="form-control" placeholder="è¯·è¾“å…¥å§“å" required>
      </div>
      
      <!-- èŒä¸š -->
      <div class="form-group">
        <label>èŒä¸š</label>
        <select id="role" class="form-control" required>
          <option value="">è¯·é€‰æ‹©</option>
          <option value="å­¦ç”Ÿ">å­¦ç”Ÿ</option>
          <option value="æ•™èŒå·¥">æ•™èŒå·¥</option>
          <option value="å¤–åŒ…">å¤–åŒ…</option>
        </select>
      </div>
      
      <!-- ISPé€‰æ‹© -->
      <div class="form-group">
        <label>è¿è¥å•†</label>
        <select id="isp" class="form-control" required>
          <option value="">è¯·é€‰æ‹©</option>
          <option value="cdu">æ ¡å›­ç½‘ï¼ˆå­¦å·¥å·ï¼‰</option>
          <option value="cmccgx">ç§»åŠ¨ï¼ˆæ‰‹æœºå·ï¼‰</option>
          <option value="96301">ç”µä¿¡ï¼ˆæ‰‹æœºå·ï¼‰</option>
          <option value="10010">è”é€šï¼ˆæ‰‹æœºå·ï¼‰</option>
        </select>
      </div>
      
      <!-- ç§»åŠ¨ä¸“å±é€‰é¡¹ -->
      <div id="cmccOptions" class="form-group hidden">
        <label>ç§»åŠ¨è´¦å·ç±»å‹</label>
        <div class="radio-group">
          <label>
            <input type="radio" name="cmccType" value="normal" checked> åŸå§‹å¯†ç 
          </label>
          <label>
            <input type="radio" name="cmccType" value="scxy"> ä¿®æ”¹è¿‡å¯†ç 
          </label>
        </div>
      </div>
      
      <!-- è´¦å· -->
      <div class="form-group">
        <label id="usernameLabel">è´¦å·</label>
        <input type="text" id="username" class="form-control" placeholder="è¯·è¾“å…¥è´¦å·" required>
        <p id="accountPreview" class="info-text text-center font-semibold hidden" style="color: #667eea;"></p>
      </div>
      
      <!-- å¯†ç  + æ˜¾ç¤ºæŒ‰é’® -->
      <div class="form-group">
        <label>å¯†ç </label>
        <div style="position: relative;">
          <input type="password" id="password" class="form-control" placeholder="è¯·è¾“å…¥å¯†ç " style="padding-right: 50px;">
          <button type="button" id="togglePassword" class="password-toggle">
            ğŸ‘ï¸
          </button>
        </div>
        <p id="passwordHint" class="info-text" style="font-size: 12px;"></p>
      </div>
      
      <button type="submit" class="btn-primary">æ¿€æ´»è´¦å·</button>
    </form>
    
    <!-- ç»“æœæ˜¾ç¤º -->
    <div id="resultBox" class="result-box hidden">
      <h2>æ¿€æ´»ç»“æœ</h2>
      <div id="resultContent"></div>
      <button id="toggleLog" class="toggle-log">æŸ¥çœ‹è¯¦ç»†æ—¥å¿—</button>
      <pre id="logBox" class="log-box hidden"></pre>
    </div>
  </div>
  
  <script>
    const ispSelect = document.getElementById('isp');
    const cmccOptions = document.getElementById('cmccOptions');
    const usernameInput = document.getElementById('username');
    const usernameLabel = document.getElementById('usernameLabel');
    const accountPreview = document.getElementById('accountPreview');
    const passwordInput = document.getElementById('password');
    const passwordHint = document.getElementById('passwordHint');
    const togglePassword = document.getElementById('togglePassword');
    const form = document.getElementById('pppoeForm');
    const resultBox = document.getElementById('resultBox');
    const resultContent = document.getElementById('resultContent');
    const logBox = document.getElementById('logBox');
    const toggleLog = document.getElementById('toggleLog');
    const nameInput = document.getElementById('name');
    const roleSelect = document.getElementById('role');
    
    const errorMessages = {
      "629": "è¿œç¨‹è®¡ç®—æœºå¼ºåˆ¶å…³é—­è¿æ¥ï¼Œè¯·ç¨åå†è¯•",
      "630": "è¿æ¥å¤±è´¥ï¼Œè®¾å¤‡ä¸å¯ç”¨ï¼Œè¯·æ£€æŸ¥æœ¬åœ°ç½‘å¡æˆ–çº¿è·¯",
      "651": "è°ƒåˆ¶è§£è°ƒå™¨æˆ–ç½‘ç»œè®¾å¤‡é”™è¯¯ï¼Œè¯·æ£€æŸ¥å®½å¸¦è®¾å¤‡è¿æ¥",
      "678": "è¿œç¨‹è®¡ç®—æœºæ— å“åº”ï¼Œå¯èƒ½æ˜¯ç½‘ç»œä¸å¯è¾¾æˆ–çº¿è·¯æœªæ¥é€š",
      "691": "è´¦å·æˆ–å¯†ç é”™è¯¯ï¼Œè¯·æ ¸å¯¹åé‡è¯•",
      "692": "ç¡¬ä»¶æ•…éšœï¼Œè¯·æ£€æŸ¥ç½‘å¡æˆ–æ‹¨å·è®¾å¤‡",
      "718": "PPP åè®®è¶…æ—¶ï¼Œå¯èƒ½ç½‘ç»œæ‹¥å¡æˆ–æœåŠ¡å™¨æ— å“åº”",
      "734": "PPP é“¾è·¯æ§åˆ¶åè®®ç»ˆæ­¢ï¼Œç½‘ç»œå¼‚å¸¸è¯·ç¨åå†è¯•",
      "769": "ç½‘ç»œä¸å¯ç”¨ï¼Œè¯·æ£€æŸ¥æœ¬åœ°è¿æ¥",
      "815": "æœåŠ¡å™¨æœªå“åº”ï¼Œè¯·è”ç³»è¿è¥å•†"
    };
    
    // ISPåˆ‡æ¢
    ispSelect.addEventListener('change', () => {
      if (ispSelect.value === "cmccgx") {
        cmccOptions.classList.remove('hidden');
        usernameLabel.textContent = "æ‰‹æœºå·";
        usernameInput.placeholder = "è¯·è¾“å…¥æ‰‹æœºå·";
      } else if (ispSelect.value === "cdu") {
        cmccOptions.classList.add('hidden');
        usernameLabel.textContent = "å­¦å·¥å·";
        usernameInput.placeholder = "è¯·è¾“å…¥å­¦å·¥å·";
      } else {
        cmccOptions.classList.add('hidden');
        usernameLabel.textContent = "æ‰‹æœºå·";
        usernameInput.placeholder = "è¯·è¾“å…¥æ‰‹æœºå·";
      }
      updatePreview();
      updatePasswordHint();
    });
    
    togglePassword.addEventListener('click', () => {
      if (passwordInput.type === "password") {
        passwordInput.type = "text";
        togglePassword.textContent = "ğŸ™ˆ";
      } else {
        passwordInput.type = "password";
        togglePassword.textContent = "ğŸ‘ï¸";
      }
    });
    
    function updatePreview() {
      let baseUser = usernameInput.value.trim();
      const isp = ispSelect.value;
      
      if (!baseUser || !isp) {
        accountPreview.classList.add('hidden');
        return;
      }
      
      if (isp === "cmccgx") {
        const cmccType = document.querySelector('input[name="cmccType"]:checked')?.value;
        if (cmccType === "scxy") {
          baseUser = "scxy" + baseUser;
        }
      }
      
      const finalUsername = baseUser + "@" + isp;
      accountPreview.textContent = "å®Œæ•´è´¦å·ï¼š" + finalUsername;
      accountPreview.classList.remove('hidden');
    }
    
    function updatePasswordHint() {
      const isp = ispSelect.value;
      const baseUser = usernameInput.value.trim();
      passwordInput.value = "";
      passwordHint.textContent = "";
      
      if (!isp) return;
      
      if (isp === "cdu") {
        passwordHint.textContent = "è¯·è¾“å…¥ç»Ÿä¸€èº«ä»½è®¤è¯å¯†ç ";
      } else if (isp === "cmccgx") {
        const cmccType = document.querySelector('input[name="cmccType"]:checked')?.value;
        if (cmccType === "normal") {
          if (baseUser.length >= 6) passwordInput.value = baseUser.slice(-6);
          passwordHint.textContent = "é»˜è®¤å¯†ç ä¸ºæ‰‹æœºå·å6ä½ï¼Œå¦‚å·²ä¿®æ”¹è¯·å¡«å†™æ­£ç¡®å¯†ç ";
        } else {
          passwordHint.textContent = "è¯·è¾“å…¥æ–°å¯†ç ";
        }
      } else if (isp === "96301") {
        if (baseUser.length >= 8) passwordInput.value = baseUser.slice(-8);
        passwordHint.textContent = "é»˜è®¤å¯†ç ä¸ºæ‰‹æœºå·å8ä½ï¼Œå¦‚å·²ä¿®æ”¹è¯·å¡«å†™æ­£ç¡®å¯†ç ";
      } else if (isp === "10010") {
        passwordHint.textContent = "é»˜è®¤å¯†ç ä¸ºèº«ä»½è¯å6ä½ï¼Œå¦‚å·²ä¿®æ”¹è¯·å¡«å†™æ­£ç¡®å¯†ç ";
      }
    }
    
    usernameInput.addEventListener('input', () => { updatePreview(); updatePasswordHint(); });
    document.querySelectorAll('input[name="cmccType"]').forEach(el => el.addEventListener('change', () => { updatePreview(); updatePasswordHint(); }));
    
    // è¡¨å•æäº¤
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      // è·å–æäº¤æŒ‰é’®
      const submitBtn = form.querySelector('button[type="submit"]');
      
      // é”å®šæŒ‰é’®
      submitBtn.disabled = true;
      submitBtn.textContent = "æ¿€æ´»ä¸­...";
      
      resultBox.classList.remove('hidden');
      resultContent.innerHTML = "<p class='info-text'>æ­£åœ¨æ¿€æ´»ï¼Œè¯·ç¨å€™...</p>";
      
      const data = {
        username: usernameInput.value.trim(),
        password: passwordInput.value,
        name: nameInput.value.trim(),
        role: roleSelect.value,
        isp: ispSelect.value
      };
      
      if (!data.isp) {
        resultContent.innerHTML = "<p class='error'>âŒ è¯·é€‰æ‹©è¿è¥å•†</p>";
        // æ¢å¤æŒ‰é’®
        submitBtn.disabled = false;
        submitBtn.textContent = "æ¿€æ´»è´¦å·";
        return;
      }
      
      if (data.isp === "cmccgx") {
        const cmccType = document.querySelector('input[name="cmccType"]:checked').value;
        if (cmccType === "scxy") data.username = "scxy" + data.username;
      }
      
      const finalUsername = data.username + "@" + data.isp;
      data.username = finalUsername;
      
      try {
        const res = await fetch('/activate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        const resp = await res.json();
        
        if (resp.success) {
          resultContent.innerHTML = `
            <p class="success">âœ… æ¿€æ´»æˆåŠŸ</p>
            <p class="info-text">è´¦å·ï¼š${resp.username}</p>
            <p class="info-text">ä½¿ç”¨æ¥å£ï¼š${resp.iface}</p>
            <p class="info-text">MACï¼š${resp.mac}</p>
            <p class="info-text">IPï¼š${resp.ip || 'æ— '}</p>
          `;
        } else {
          // ä¼˜å…ˆä½¿ç”¨åç«¯è¿”å›çš„è¯¦ç»†é”™è¯¯æ¶ˆæ¯ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨é”™è¯¯ç æ˜ å°„
          const userTip = resp.error_message || errorMessages[resp.error_code] || "æœªçŸ¥é”™è¯¯";
          resultContent.innerHTML = `
            <p class="error">âŒ æ¿€æ´»å¤±è´¥</p>
            <p class="info-text">é”™è¯¯ç ï¼š${resp.error_code}</p>
            <p class="info-text">æç¤ºï¼š${userTip}</p>
            <p class="info-text">è´¦å·ï¼š${resp.username}</p>
            <p class="info-text">ä½¿ç”¨æ¥å£ï¼š${resp.iface}</p>
          `;
        }
        
        logBox.textContent = resp.log || "æ— æ—¥å¿—ä¿¡æ¯";
      } catch (err) {
        resultContent.innerHTML = "<p class='error'>è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥</p>";
      } finally {
        // æ¢å¤æŒ‰é’®
        submitBtn.disabled = false;
        submitBtn.textContent = "æ¿€æ´»è´¦å·";
      }
    });
    
    // æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
    toggleLog.addEventListener('click', async () => {
      if (logBox.classList.contains('hidden')) {
        logBox.classList.remove('hidden');
        logBox.innerHTML = "<p class='log-loading'>æ­£åœ¨åŠ è½½æ—¥å¿—...</p>";
        
        try {
          const res = await fetch('/api/dial-logs');
          if (res.ok) {
            const data = await res.json();
            if (data.success && data.log_content) {
              logBox.textContent = `ã€æ—¥å¿—æ–‡ä»¶ï¼š${data.log_file}ã€‘\n\n${data.log_content}`;
            } else {
              logBox.textContent = data.error || "æš‚æ— æ—¥å¿—è®°å½•";
            }
          } else {
            logBox.textContent = "åŠ è½½æ—¥å¿—å¤±è´¥";
          }
        } catch (err) {
          logBox.textContent = "åŠ è½½æ—¥å¿—å¤±è´¥";
        }
      } else {
        logBox.classList.add('hidden');
      }
    });
  </script>
</body>
</html>
