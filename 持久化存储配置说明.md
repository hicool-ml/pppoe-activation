# Docker 持久化存储配置说明

## 概述

本说明文档介绍如何配置 PPPOE 激活系统的 Docker 容器数据持久化，确保数据库和日志在容器重启或删除后不会丢失。

## 持久化存储的重要性

Docker 容器是临时的，当容器被删除或重新创建时，容器内的所有数据都会丢失。为了保护重要数据，需要将数据存储在宿主机上，并通过卷挂载的方式映射到容器内。

## 数据持久化方案

### 1. 环境变量配置

在项目根目录下创建 `.env` 文件，配置持久化存储路径：

```bash
# 复制示例配置文件
cp .env.example .env

# 编辑配置文件
nano .env
```

### 2. 持久化目录说明

#### 数据库文件（重要！）

```yaml
volumes:
  # 数据库文件（重要！）
  - ${DB_PATH:-./database.db}:/opt/pppoe-activation/database.db
```

**说明**：
- 宿主机路径：`./database.db`（默认在项目根目录）
- 容器内路径：`/opt/pppoe-activation/database.db`
- 用途：存储所有激活记录和管理员信息
- 重要性：⭐⭐⭐⭐⭐（非常重要，必须持久化）

#### 实例目录（包含数据库）

```yaml
volumes:
  # 实例目录（包含数据库）
  - ${INSTANCE_PATH:-./instance}:/opt/pppoe-activation/instance
```

**说明**：
- 宿主机路径：`./instance`（默认在项目根目录）
- 容器内路径：`/opt/pppoe-activation/instance`
- 用途：存储数据库实例文件
- 重要性：⭐⭐⭐⭐⭐（非常重要，必须持久化）

#### 日志目录

```yaml
volumes:
  # 日志目录
  - ${LOGS_PATH:-./logs}:/opt/pppoe-activation/logs
```

**说明**：
- 宿主机路径：`./logs`（默认在项目根目录）
- 容器内路径：`/opt/pppoe-activation/logs`
- 用途：存储 PPPoE 拨号日志
- 重要性：⭐⭐⭐（重要，用于故障排查）

#### 数据目录

```yaml
volumes:
  # 数据目录
  - ${DATA_PATH:-./data}:/opt/pppoe-activation/data
```

**说明**：
- 宿主机路径：`./data`（默认在项目根目录）
- 容器内路径：`/opt/pppoe-activation/data`
- 用途：存储其他数据文件
- 重要性：⭐⭐（中等重要）

### 3. 完整的 .env 配置示例

```bash
# 应用端口配置
APP_PORT=8080
ADMIN_PORT=8081

# 网卡配置（根据实际情况修改）
NETWORK_INTERFACES=eth0 eth1 eth2 eth3

# 时区配置
TZ=Asia/Shanghai

# 数据持久化路径配置
DATA_PATH=./data
LOGS_PATH=./logs
DB_PATH=./database.db
INSTANCE_PATH=./instance
```

### 4. 自定义持久化路径

如果需要将数据存储在其他位置，可以修改 `.env` 文件中的路径：

#### 示例 1：存储在 /data 目录

```bash
DATA_PATH=/data/pppoe-activation/data
LOGS_PATH=/data/pppoe-activation/logs
DB_PATH=/data/pppoe-activation/database.db
INSTANCE_PATH=/data/pppoe-activation/instance
```

#### 示例 2：存储在 /home/user/pppoe 目录

```bash
DATA_PATH=/home/user/pppoe/data
LOGS_PATH=/home/user/pppoe/logs
DB_PATH=/home/user/pppoe/database.db
INSTANCE_PATH=/home/user/pppoe/instance
```

#### 示例 3：存储在 NFS 共享目录

```bash
DATA_PATH=/mnt/nfs/pppoe-activation/data
LOGS_PATH=/mnt/nfs/pppoe-activation/logs
DB_PATH=/mnt/nfs/pppoe-activation/database.db
INSTANCE_PATH=/mnt/nfs/pppoe-activation/instance
```

### 5. 目录权限设置

确保宿主机上的持久化目录具有正确的权限：

```bash
# 创建数据目录
mkdir -p data logs instance

# 设置权限（可选，根据需要调整）
chmod 755 data logs instance
```

### 6. 验证持久化配置

#### 启动容器

```bash
docker-compose up -d
```

#### 检查挂载点

```bash
# 查看容器的挂载点
docker inspect pppoe-activation | grep -A 10 Mounts
```

#### 验证数据持久化

```bash
# 在容器内创建测试文件
docker exec pppoe-activation touch /opt/pppoe-activation/data/test.txt

# 检查宿主机上是否存在
ls -la ./data/
```

### 7. 备份持久化数据

#### 手动备份

```bash
# 备份数据库
cp database.db database.db.backup.$(date +%Y%m%d_%H%M%S)

# 备份日志
tar -czf logs.backup.$(date +%Y%m%d_%H%M%S).tar.gz logs/

# 备份实例目录
tar -czf instance.backup.$(date +%Y%m%d_%H%M%S).tar.gz instance/
```

#### 自动备份脚本

创建 `backup.sh` 脚本：

```bash
#!/bin/bash

BACKUP_DIR="./backups"
DATE=$(date +%Y%m%d_%H%M%S)

mkdir -p $BACKUP_DIR

# 备份数据库
cp database.db $BACKUP_DIR/database.db.$DATE

# 备份日志
tar -czf $BACKUP_DIR/logs.$DATE.tar.gz logs/

# 备份实例目录
tar -czf $BACKUP_DIR/instance.$DATE.tar.gz instance/

# 保留最近 7 天的备份
find $BACKUP_DIR -name "*.db.*" -mtime +7 -delete
find $BACKUP_DIR -name "*.tar.gz" -mtime +7 -delete

echo "备份完成: $BACKUP_DIR"
```

设置定时任务（每天凌晨 2 点备份）：

```bash
# 编辑 crontab
crontab -e

# 添加以下行
0 2 * * * /path/to/backup.sh >> /var/log/pppoe-backup.log 2>&1
```

### 8. 恢复持久化数据

#### 恢复数据库

```bash
# 停止容器
docker-compose down

# 恢复数据库
cp database.db.backup.20250119_020000 database.db

# 启动容器
docker-compose up -d
```

#### 恢复日志

```bash
# 停止容器
docker-compose down

# 恢复日志
tar -xzf logs.backup.20250119_020000.tar.gz -C ./

# 启动容器
docker-compose up -d
```

### 9. 迁移持久化数据

如果需要将数据迁移到其他服务器：

```bash
# 在源服务器上打包数据
tar -czf pppoe-data.tar.gz data logs instance database.db

# 传输到目标服务器
scp pppoe-data.tar.gz user@target-server:/path/to/pppoe-activation/

# 在目标服务器上解压
cd /path/to/pppoe-activation
tar -xzf pppoe-data.tar.gz

# 启动容器
docker-compose up -d
```

### 10. 监控磁盘空间

定期检查持久化目录的磁盘空间使用情况：

```bash
# 查看目录大小
du -sh data logs instance database.db

# 查看磁盘使用情况
df -h
```

### 11. 清理旧日志

如果日志文件过多，可以定期清理：

```bash
# 清理 30 天前的日志
find logs -name "*.log" -mtime +30 -delete

# 清理空日志文件
find logs -name "*.log" -size 0 -delete
```

## 常见问题

### Q: 为什么数据库会丢失？

A: 可能的原因：
1. 没有正确配置 `DB_PATH` 环境变量
2. 宿主机路径不存在或权限不足
3. 使用了 `docker-compose down -v` 命令（会删除卷）

### Q: 如何查看容器内的数据？

A: 使用以下命令：

```bash
# 进入容器
docker exec -it pppoe-activation bash

# 查看数据
ls -la /opt/pppoe-activation/

# 退出容器
exit
```

### Q: 可以在宿主机上直接修改数据库吗？

A: 不建议。应该：
1. 停止容器：`docker-compose down`
2. 备份数据库：`cp database.db database.db.backup`
3. 修改数据库
4. 启动容器：`docker-compose up -d`

### Q: 如何使用外部数据库？

A: 修改 `config.py` 中的 `DATABASE_PATH`，并确保容器可以访问外部数据库。

### Q: 持久化数据会占用多少空间？

A: 取决于使用情况：
- 数据库：通常几 MB 到几百 MB
- 日志：取决于日志保留策略，可能几 GB
- 数据目录：取决于存储的数据量

## 总结

通过正确配置持久化存储，可以确保：

✅ 数据库数据不会丢失
✅ 日志可以长期保存
✅ 容器重启后数据保持一致
✅ 方便备份和恢复
✅ 方便迁移到其他服务器

**重要提醒**：
1. 务必配置 `DB_PATH` 和 `INSTANCE_PATH`
2. 定期备份数据库
3. 监控磁盘空间使用情况
4. 不要使用 `docker-compose down -v` 命令（会删除卷）
