<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PPPoEè´¦å·æ¿€æ´»</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center">
  <div class="w-full max-w-md bg-white rounded-2xl shadow-lg p-6">
    <h1 class="text-2xl font-bold text-center mb-6">PPPoEè´¦å·æ¿€æ´»</h1>

    <!-- è¾“å…¥è¡¨å• -->
    <form id="pppoeForm" class="space-y-4">
      <!-- å§“å -->
      <div>
        <label class="block text-sm font-medium mb-1">å§“å</label>
        <input type="text" id="name" class="w-full p-3 border rounded-xl focus:ring focus:ring-blue-300" placeholder="è¯·è¾“å…¥å§“å" required>
      </div>

      <!-- èŒä¸š -->
      <div>
        <label class="block text-sm font-medium mb-1">èŒä¸š</label>
        <select id="role" class="w-full p-3 border rounded-xl focus:ring focus:ring-blue-300" required>
          <option value="">è¯·é€‰æ‹©</option>
          <option value="å­¦ç”Ÿ">å­¦ç”Ÿ</option>
          <option value="æ•™èŒå·¥">æ•™èŒå·¥</option>
          <option value="å¤–åŒ…">å¤–åŒ…</option>
        </select>
      </div>

      <!-- ISPé€‰æ‹© -->
      <div>
        <label class="block text-sm font-medium mb-1">è¿è¥å•†</label>
        <select id="isp" class="w-full p-3 border rounded-xl focus:ring focus:ring-blue-300" required>
          <option value="">è¯·é€‰æ‹©</option>
          <option value="cdu">æ ¡å›­ç½‘ï¼ˆå­¦å·¥å·ï¼‰</option>
          <option value="cmccgx">ç§»åŠ¨ï¼ˆæ‰‹æœºå·ï¼‰</option>
          <option value="96301">ç”µä¿¡ï¼ˆæ‰‹æœºå·ï¼‰</option>
          <option value="10010">è”é€šï¼ˆæ‰‹æœºå·ï¼‰</option>
        </select>
      </div>

      <!-- ç§»åŠ¨ä¸“å±é€‰é¡¹ -->
      <div id="cmccOptions" class="hidden">
        <label class="block text-sm font-medium mb-1">ç§»åŠ¨è´¦å·ç±»å‹</label>
        <div class="flex items-center space-x-4">
          <label class="flex items-center">
            <input type="radio" name="cmccType" value="normal" checked class="mr-2"> åŸå§‹å¯†ç 
          </label>
          <label class="flex items-center">
            <input type="radio" name="cmccType" value="scxy" class="mr-2"> ä¿®æ”¹è¿‡å¯†ç 
          </label>
        </div>
      </div>

      <!-- è´¦å· -->
      <div>
        <label id="usernameLabel" class="block text-sm font-medium mb-1">è´¦å·</label>
        <input type="text" id="username" class="w-full p-3 border rounded-xl focus:ring focus:ring-blue-300" placeholder="è¯·è¾“å…¥è´¦å·" required>
        <p id="accountPreview" class="mt-2 text-center font-semibold text-blue-600 hidden"></p>
      </div>

      <!-- å¯†ç  + æ˜¾ç¤ºæŒ‰é’® -->
      <div>
        <label class="block text-sm font-medium mb-1">å¯†ç </label>
        <div class="relative">
          <input type="password" id="password" class="w-full p-3 border rounded-xl focus:ring focus:ring-blue-300 pr-12" placeholder="è¯·è¾“å…¥å¯†ç ">
          <button type="button" id="togglePassword" class="absolute inset-y-0 right-3 flex items-center text-gray-500">
            ğŸ‘ï¸
          </button>
        </div>
        <p id="passwordHint" class="mt-1 text-xs text-gray-500"></p>
      </div>

      <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-xl font-semibold hover:bg-blue-700">æ¿€æ´»è´¦å·</button>
    </form>

    <!-- ç»“æœæ˜¾ç¤º -->
    <div id="resultBox" class="mt-6 hidden">
      <h2 class="text-lg font-bold mb-2">æ¿€æ´»ç»“æœ</h2>
      <div id="resultContent" class="p-3 rounded-xl"></div>
      <button id="toggleLog" class="mt-3 text-blue-600 underline text-sm">æŸ¥çœ‹è¯¦ç»†æ—¥å¿—</button>
      <pre id="logBox" class="hidden mt-3 p-3 bg-gray-100 rounded-lg overflow-x-auto text-xs"></pre>
    </div>
  </div>

  <script>
    const ispSelect = document.getElementById('isp');
    const cmccOptions = document.getElementById('cmccOptions');
    const usernameInput = document.getElementById('username');
    const usernameLabel = document.getElementById('usernameLabel');
    const accountPreview = document.getElementById('accountPreview');
    const passwordInput = document.getElementById('password');
    const passwordHint = document.getElementById('passwordHint');
    const togglePassword = document.getElementById('togglePassword');
    const form = document.getElementById('pppoeForm');
    const resultBox = document.getElementById('resultBox');
    const resultContent = document.getElementById('resultContent');
    const logBox = document.getElementById('logBox');
    const toggleLog = document.getElementById('toggleLog');
    const nameInput = document.getElementById('name');
    const roleSelect = document.getElementById('role');

    const errorMessages = {
      "629": "è¿œç¨‹è®¡ç®—æœºå¼ºåˆ¶å…³é—­è¿æ¥ï¼Œè¯·ç¨åå†è¯•",
      "630": "è¿æ¥å¤±è´¥ï¼Œè®¾å¤‡ä¸å¯ç”¨ï¼Œè¯·æ£€æŸ¥æœ¬åœ°ç½‘å¡æˆ–çº¿è·¯",
      "651": "è°ƒåˆ¶è§£è°ƒå™¨æˆ–ç½‘ç»œè®¾å¤‡é”™è¯¯ï¼Œè¯·æ£€æŸ¥å®½å¸¦è®¾å¤‡è¿æ¥",
      "678": "è¿œç¨‹è®¡ç®—æœºæ— å“åº”ï¼Œå¯èƒ½æ˜¯ç½‘ç»œä¸å¯è¾¾æˆ–çº¿è·¯æœªæ¥é€š",
      "691": "è´¦å·æˆ–å¯†ç é”™è¯¯ï¼Œè¯·æ ¸å¯¹åé‡è¯•",
      "692": "ç¡¬ä»¶æ•…éšœï¼Œè¯·æ£€æŸ¥ç½‘å¡æˆ–æ‹¨å·è®¾å¤‡",
      "718": "PPP åè®®è¶…æ—¶ï¼Œå¯èƒ½ç½‘ç»œæ‹¥å¡æˆ–æœåŠ¡å™¨æ— å“åº”",
      "734": "PPP é“¾è·¯æ§åˆ¶åè®®ç»ˆæ­¢ï¼Œç½‘ç»œå¼‚å¸¸è¯·ç¨åå†è¯•",
      "769": "ç½‘ç»œä¸å¯ç”¨ï¼Œè¯·æ£€æŸ¥æœ¬åœ°è¿æ¥",
      "815": "æœåŠ¡å™¨æœªå“åº”ï¼Œè¯·è”ç³»è¿è¥å•†"
    };

    // ISPåˆ‡æ¢
    ispSelect.addEventListener('change', () => {
      if (ispSelect.value === "cmccgx") {
        cmccOptions.classList.remove('hidden');
        usernameLabel.textContent = "æ‰‹æœºå·";
        usernameInput.placeholder = "è¯·è¾“å…¥æ‰‹æœºå·";
      } else if (ispSelect.value === "cdu") {
        cmccOptions.classList.add('hidden');
        usernameLabel.textContent = "å­¦å·¥å·";
        usernameInput.placeholder = "è¯·è¾“å…¥å­¦å·¥å·";
      } else {
        cmccOptions.classList.add('hidden');
        usernameLabel.textContent = "æ‰‹æœºå·";
        usernameInput.placeholder = "è¯·è¾“å…¥æ‰‹æœºå·";
      }
      updatePreview();
      updatePasswordHint();
    });

    togglePassword.addEventListener('click', () => {
      if (passwordInput.type === "password") {
        passwordInput.type = "text";
        togglePassword.textContent = "ğŸ™ˆ";
      } else {
        passwordInput.type = "password";
        togglePassword.textContent = "ğŸ‘ï¸";
      }
    });

    function updatePreview() {
      let baseUser = usernameInput.value.trim();
      const isp = ispSelect.value;

      if (!baseUser || !isp) {
        accountPreview.classList.add('hidden');
        return;
      }

      if (isp === "cmccgx") {
        const cmccType = document.querySelector('input[name="cmccType"]:checked')?.value;
        if (cmccType === "scxy") {
          baseUser = "scxy" + baseUser;
        }
      }

      const finalUsername = baseUser + "@" + isp;
      accountPreview.textContent = "å®Œæ•´è´¦å·ï¼š" + finalUsername;
      accountPreview.classList.remove('hidden');
    }

    function updatePasswordHint() {
      const isp = ispSelect.value;
      const baseUser = usernameInput.value.trim();
      passwordInput.value = "";
      passwordHint.textContent = "";

      if (!isp) return;

      if (isp === "cdu") {
        passwordHint.textContent = "è¯·è¾“å…¥ç»Ÿä¸€èº«ä»½è®¤è¯å¯†ç ";
      } else if (isp === "cmccgx") {
        const cmccType = document.querySelector('input[name="cmccType"]:checked')?.value;
        if (cmccType === "normal") {
          if (baseUser.length >= 6) passwordInput.value = baseUser.slice(-6);
          passwordHint.textContent = "é»˜è®¤å¯†ç ä¸ºæ‰‹æœºå·å6ä½ï¼Œå¦‚å·²ä¿®æ”¹è¯·å¡«å†™æ­£ç¡®å¯†ç ";
        } else {
          passwordHint.textContent = "è¯·è¾“å…¥æ–°å¯†ç ";
        }
      } else if (isp === "96301") {
        if (baseUser.length >= 8) passwordInput.value = baseUser.slice(-8);
        passwordHint.textContent = "é»˜è®¤å¯†ç ä¸ºæ‰‹æœºå·å8ä½ï¼Œå¦‚å·²ä¿®æ”¹è¯·å¡«å†™æ­£ç¡®å¯†ç ";
      } else if (isp === "10010") {
        passwordHint.textContent = "é»˜è®¤å¯†ç ä¸ºèº«ä»½è¯å6ä½ï¼Œå¦‚å·²ä¿®æ”¹è¯·å¡«å†™æ­£ç¡®å¯†ç ";
      }
    }

    usernameInput.addEventListener('input', () => { updatePreview(); updatePasswordHint(); });
    document.querySelectorAll('input[name="cmccType"]').forEach(el => el.addEventListener('change', () => { updatePreview(); updatePasswordHint(); }));

    // è¡¨å•æäº¤
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      resultBox.classList.remove('hidden');
      resultContent.innerHTML = "<p class='text-gray-500'>æ­£åœ¨æ¿€æ´»ï¼Œè¯·ç¨å€™...</p>";

      const data = {
        username: usernameInput.value.trim(),
        password: passwordInput.value,
        name: nameInput.value.trim(),
        role: roleSelect.value,
        isp: ispSelect.value
      };

      if (!data.isp) {
        resultContent.innerHTML = `<p class="text-red-600">âŒ è¯·é€‰æ‹©è¿è¥å•†</p>`;
        return;
      }

      if (data.isp === "cmccgx") {
        const cmccType = document.querySelector('input[name="cmccType"]:checked').value;
        if (cmccType === "scxy") data.username = "scxy" + data.username;
      }

      const finalUsername = data.username + "@" + data.isp;
      data.username = finalUsername;

      try {
        const res = await fetch('/activate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        const resp = await res.json();

        if (resp.success) {
          resultContent.innerHTML = `
            <p class="text-green-600 font-semibold">âœ… æ¿€æ´»æˆåŠŸ</p>
            <p class="mt-1 text-sm">è´¦å·ï¼š${resp.username}</p>
            <p class="text-sm">ä½¿ç”¨æ¥å£ï¼š${resp.iface}</p>
            <p class="text-sm">MACï¼š${resp.mac}</p>
            <p class="text-sm">IPï¼š${resp.ip || 'æ— '}</p>
          `;
        } else {
          const userTip = errorMessages[resp.error_code] || resp.error_message || "æœªçŸ¥é”™è¯¯";
          resultContent.innerHTML = `
            <p class="text-red-600 font-semibold">âŒ æ¿€æ´»å¤±è´¥</p>
            <p class="mt-1 text-sm">é”™è¯¯ç ï¼š${resp.error_code}</p>
            <p class="text-sm">æç¤ºï¼š${userTip}</p>
            <p class="text-sm">è´¦å·ï¼š${resp.username}</p>
            <p class="text-sm">ä½¿ç”¨æ¥å£ï¼š${resp.iface}</p>
          `;
        }

        logBox.textContent = resp.log || "æ— æ—¥å¿—ä¿¡æ¯";
      } catch (err) {
        resultContent.innerHTML = `<p class="text-red-600 font-semibold">è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥</p>`;
      }
    });

    toggleLog.addEventListener('click', () => logBox.classList.toggle('hidden'));
  </script>
</body>
</html>
