<!-- templates/dashboard.html -->
<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>PPPoE æ¿€æ´»è®°å½•çœ‹æ¿</title>
    <link href="/static/css/bootstrap.min.css" rel="stylesheet"/>
    <style>
        body { padding-top: 60px; }
        .status-ok { color: #0d6efd; }
        .status-fail { color: #dc3545; }
        .table-hover tbody tr:hover { background-color: #f8f9fa; }
    </style>
</head>
<body>
<div class="container">
    <h2>ğŸ“Š PPPoE æ¿€æ´»è®°å½•çœ‹æ¿</h2>

    <div class="mb-3 d-flex gap-2 align-items-end">
        <div>
            <label class="form-label">å¼€å§‹æ—¶é—´</label>
            <input type="datetime-local" id="start_time" class="form-control" />
        </div>
        <div>
            <label class="form-label">ç»“æŸæ—¶é—´</label>
            <input type="datetime-local" id="end_time" class="form-control" />
        </div>
        <button class="btn btn-success" onclick="exportCSV()">å¯¼å‡º CSV</button>
    </div>

    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">ğŸ“ˆ æŒ‰è¿è¥å•†åˆ†ç»„ç»Ÿè®¡</h5>
        </div>
        <div class="table-responsive">
            <table class="table table-bordered mb-0">
                <thead class="table-light">
                <tr>
                    <th>è¿è¥å•† (ISP)</th>
                    <th>æ€»æ¬¡æ•°</th>
                    <th>æˆåŠŸæ•°</th>
                    <th>å¤±è´¥æ•°</th>
                    <th>æˆåŠŸç‡</th>
                </tr>
                </thead>
                <tbody id="statsTable">
                <tr><td colspan="5" class="text-center">åŠ è½½ä¸­...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <p>å®æ—¶æŸ¥çœ‹ç”¨æˆ·æ¿€æ´»çŠ¶æ€</p>
    <table class="table table-striped table-hover">
        <thead class="table-dark">
        <tr>
            <th>å§“å</th>
            <th>è§’è‰²</th>
            <th>è¿è¥å•†</th>
            <th>è´¦å·</th>
            <th>çŠ¶æ€</th>
            <th>IPåœ°å€</th>
            <th>MACåœ°å€</th>
            <th>æ—¶é—´</th>
        </tr>
        </thead>
        <tbody id="logTable">
        <tr><td colspan="8" class="text-center">åŠ è½½ä¸­...</td></tr>
        </tbody>
    </table>

    <!-- åˆ†é¡µæ§ä»¶ -->
    <div id="pagination" class="mt-3" style="display:none;"></div>
</div>

<script src="/static/js/jquery.min.js"></script>
<script>
    let currentPage = 1;
    const perPage = 20;
    let refreshTimer = null;

    function loadStats() {
        $.getJSON('/stats', function (data) {
            const tbody = $('#statsTable');
            tbody.empty();
            if (data.length === 0) {
                tbody.append('<tr><td colspan="5" class="text-center">æš‚æ— æ•°æ®</td></tr>');
                return;
            }
            data.forEach(row => {
                // âœ… ä¿®å¤ï¼šä½¿ç”¨æ­£ç¡®çš„å­—æ®µå 'failure' å’Œ 'rate'
                tbody.append(`
                    <tr>
                        <td>${row.isp}</td>
                        <td>${row.total}</td>
                        <td>${row.success}</td>
                        <td>${row.failure}</td>      <!-- åŸä¸º row.fail âŒ -->
                        <td>${row.rate}</td>         <!-- åŸä¸º row.success_rate âŒ -->
                    </tr>
                `);
            });
        }).fail((jqxhr, textStatus, error) => {
            console.error("Stats load failed:", textStatus, error);
            $('#statsTable').html('<tr><td colspan="5" class="text-center text-danger">âŒ åŠ è½½å¤±è´¥</td></tr>');
        });
    }

    function loadLogs(page = 1) {
        currentPage = page;
        $.getJSON('/logs', {page: page, per_page: perPage}, function (resp) {
            const tbody = $('#logTable');
            tbody.empty();
            if (resp.data.length === 0) {
                tbody.append('<tr><td colspan="8" class="text-center">æš‚æ— æ•°æ®</td></tr>');
                $('#pagination').hide();
                return;
            }
            resp.data.forEach(log => {
                const status = log.success ?
                    `<span class="status-ok">âœ… æˆåŠŸ</span>` :
                    `<span class="status-fail">âŒ å¤±è´¥ (Code: ${log.error_code})</span>`;
                tbody.append(`
                    <tr>
                        <td>${log.name}</td>
                        <td>${log.role}</td>
                        <td>${log.isp}</td>
                        <td><code>${log.username}</code></td>
                        <td>${status}</td>
                        <td>${log.ip || '-'}</td>
                        <td><code>${log.mac || '-'}</code></td>
                        <td>${log.timestamp}</td>
                    </tr>
                `);
            });
            updatePagination(resp.page, resp.pages);
        }).fail(() => {
            $('#logTable').html('<tr><td colspan="8" class="text-center text-danger">âŒ åŠ è½½å¤±è´¥</td></tr>');
            $('#pagination').hide();
        });
    }

    function updatePagination(current, total) {
        const container = $('#pagination');
        if (total <= 1) {
            container.hide();
            return;
        }
        container.show();
        let html = `<nav aria-label="åˆ†é¡µ"><ul class="pagination pagination-sm justify-content-center">`;
        if (current > 1) {
            html += `<li class="page-item"><a class="page-link" href="#" data-page="${current - 1}">&laquo; ä¸Šä¸€é¡µ</a></li>`;
        } else {
            html += `<li class="page-item disabled"><span class="page-link">&laquo; ä¸Šä¸€é¡µ</span></li>`;
        }
        html += `<li class="page-item disabled"><span class="page-link">ç¬¬ ${current} é¡µï¼Œå…± ${total} é¡µ</span></li>`;
        if (current < total) {
            html += `<li class="page-item"><a class="page-link" href="#" data-page="${current + 1}">ä¸‹ä¸€é¡µ &raquo;</a></li>`;
        } else {
            html += `<li class="page-item disabled"><span class="page-link">ä¸‹ä¸€é¡µ &raquo;</span></li>`;
        }
        html += `</ul></nav>`;
        container.html(html);
        container.find('a[data-page]').on('click', function (e) {
            e.preventDefault();
            loadLogs($(this).data('page'));
        });
    }

    function exportCSV() {
        const start = $('#start_time').val();
        const end = $('#end_time').val();
        let url = '/export_csv';
        if (start) url += `?start=${start}`;
        if (end) url += start ? `&end=${end}` : `?end=${end}`;
        const a = document.createElement('a');
        a.href = url;
        a.download = 'pppoe_logs.csv';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }

    $(function () {
        loadStats();
        loadLogs(currentPage);
        setInterval(loadStats, 10000);
        refreshTimer = setInterval(() => loadLogs(currentPage), 5000);
    });
</script>
</body>
</html>
