# PPPOE 激活系统 Docker 部署指南

## 概述

本指南介绍如何使用 Docker 部署 PPPOE 激活系统，包括首次配置、网卡选择、持久化存储等。

## 系统要求

- Docker 20.10+
- Docker Compose 1.29+
- Linux 系统（推荐 Ubuntu 20.04+）
- 至少一个网络接口用于 PPPOE 拨号
- 至少 2GB 可用内存
- 至少 10GB 可用磁盘空间

## ⚠️ 容器部署关键点

### 1. 服务端口配置

本系统提供两个对外服务端口：

| 端口 | 服务 | 用途 | 默认值 |
|------|------|------|--------|
| 80 | 用户激活页面 | 用户访问的激活界面 | 80 |
| 8081 | 管理后台页面 | 管理员登录和管理界面 | 8081 |

**重要说明**：
- 端口 80 用于用户激活页面，是主要的对外服务端口
- 端口 8081 用于管理后台，仅供管理员使用
- 两个端口都可以在 `.env` 文件中自定义配置

### 2. 网络模式配置（关键！）

由于 PPPOE 拨号需要直接访问宿主机的物理网卡，**必须使用 `host` 网络模式**，而不是默认的 bridge 模式。

**docker-compose.yml 配置**：
```yaml
services:
  pppoe-activation:
    # ... 其他配置 ...
    network_mode: "host"  # ⚠️ 必须使用 host 网络模式
    # 不要使用 ports 映射，因为 host 模式会直接使用宿主机网络
```

**为什么必须使用 host 网络模式**：
- PPPOE 拨号需要直接访问物理网卡（如 eth0, enp3s0 等）
- bridge 模式会创建虚拟网络接口，无法直接访问物理网卡
- host 模式让容器直接使用宿主机的网络栈，可以访问所有物理网卡

**host 网络模式的影响**：
- ✅ 容器可以直接访问宿主机的所有物理网卡
- ✅ 容器可以直接使用宿主机的网络配置
- ✅ 无需端口映射，容器直接监听宿主机端口
- ⚠️ 容器与宿主机共享网络命名空间，端口不能冲突
- ⚠️ 安全性略低于 bridge 模式

### 3. 设备映射配置（关键！）

PPPOE 拨号需要访问宿主机的 `/dev/ppp` 设备，**必须将该设备映射到容器中**。

**docker-compose.yml 配置**：
```yaml
services:
  pppoe-activation:
    # ... 其他配置 ...
    devices:
      - /dev/net/tun:/dev/net/tun  # TUN 设备（用于 VPN）
      - /dev/ppp:/dev/ppp           # ⚠️ PPP 设备（用于 PPPOE 拨号）
```

**为什么必须映射 /dev/ppp 设备**：
- PPPOE 拨号需要使用 PPP 协议
- PPP 协议需要访问 `/dev/ppp` 设备
- 如果不映射该设备，PPPOE 拨号会失败，错误信息：
  ```
  Couldn't open the /dev/ppp device: No such file or directory
  Linux kernel does not support PPPoE
  ```

**验证设备映射**：
```bash
# 检查宿主机上是否存在 /dev/ppp 设备
ls -la /dev/ppp

# 检查容器内是否存在 /dev/ppp 设备
docker exec pppoe-activation ls -la /dev/ppp
```

### 4. 权限配置（关键！）

容器需要足够的权限来执行网络操作和 PPPOE 拨号。

**docker-compose.yml 配置**：
```yaml
services:
  pppoe-activation:
    # ... 其他配置 ...
    cap_add:
      - NET_ADMIN    # ⚠️ 网络管理权限（必需）
      - SYS_ADMIN    # ⚠️ 系统管理权限（必需）
    privileged: true  # ⚠️ 特权模式（推荐）
    security_opt:
      - seccomp:unconfined  # ⚠️ 禁用 seccomp 限制（推荐）
```

**为什么需要这些权限**：
- `NET_ADMIN`：允许容器执行网络管理操作，如修改网卡配置
- `SYS_ADMIN`：允许容器执行系统管理操作，如加载内核模块
- `privileged: true`：给予容器完全的宿主机访问权限
- `seccomp:unconfined`：禁用系统调用过滤，允许更多系统操作

**权限说明**：
| 权限 | 用途 | 是否必需 |
|------|------|----------|
| NET_ADMIN | 网络管理（修改网卡、路由等） | ✅ 必需 |
| SYS_ADMIN | 系统管理（加载内核模块等） | ✅ 必需 |
| privileged | 特权模式（完全访问宿主机） | ✅ 推荐 |
| seccomp:unconfined | 禁用系统调用过滤 | ✅ 推荐 |

### 5. 网卡配置（关键！）

容器需要知道使用哪些物理网卡进行 PPPOE 拨号。

**配置方法**：

**方法 1：通过 .env 文件配置**
```bash
# 编辑 .env 文件
NETWORK_INTERFACES=enp3s0 enp4s0 enp5s0 enp6s0
```

**方法 2：通过 config.py 文件配置**
```python
# 编辑 config.py 文件
NETWORK_INTERFACES = ['enp3s0', 'enp4s0', 'enp5s0', 'enp6s0']
```

**查看可用网卡**：
```bash
# 在宿主机上查看
ip link show

# 在容器内查看
docker exec pppoe-activation ip link show
```

**网卡命名规则**：
- 传统命名：eth0, eth1, eth2, eth3
- 一致性命名：enp3s0, enp4s0, enp5s0, enp6s0
- USB 网卡：enx00e04c000000（以 enx 开头）

### 6. 完整的 docker-compose.yml 配置示例

```yaml
version: '3.8'

services:
  pppoe-activation:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: pppoe-activation
    hostname: pppoe-activation
    restart: unless-stopped
    
    # ⚠️ 关键配置 1：使用 host 网络模式
    network_mode: "host"
    
    # ⚠️ 关键配置 2：映射必要的设备
    devices:
      - /dev/net/tun:/dev/net/tun
      - /dev/ppp:/dev/ppp
    
    # ⚠️ 关键配置 3：添加必要的权限
    cap_add:
      - NET_ADMIN
      - SYS_ADMIN
    privileged: true
    security_opt:
      - seccomp:unconfined
    
    environment:
      - TZ=Asia/Shanghai
      - APP_PORT=80
      - ADMIN_PORT=8081
      - NETWORK_INTERFACES=enp3s0 enp4s0 enp5s0 enp6s0
    
    volumes:
      - ./data:/opt/pppoe-activation/data
      - ./logs:/opt/pppoe-activation/logs
      - ./database.db:/opt/pppoe-activation/database.db
      - ./instance:/opt/pppoe-activation/instance
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
```

### 7. 常见部署错误及解决方案

#### 错误 1：PPPOE 拨号失败，提示 /dev/ppp 设备不存在

**错误信息**：
```
Couldn't open the /dev/ppp device: No such file or directory
Linux kernel does not support PPPoE
```

**原因**：容器内没有映射 `/dev/ppp` 设备

**解决方案**：
```yaml
# 在 docker-compose.yml 中添加设备映射
devices:
  - /dev/ppp:/dev/ppp
```

#### 错误 2：无法访问物理网卡

**错误信息**：
```
接口 enp3s0 不存在
```

**原因**：使用了 bridge 网络模式，无法访问物理网卡

**解决方案**：
```yaml
# 在 docker-compose.yml 中使用 host 网络模式
network_mode: "host"
```

#### 错误 3：权限不足，无法修改网卡配置

**错误信息**：
```
RTNETLINK answers: Operation not permitted
```

**原因**：容器没有足够的网络管理权限

**解决方案**：
```yaml
# 在 docker-compose.yml 中添加权限
cap_add:
  - NET_ADMIN
  - SYS_ADMIN
privileged: true
```

#### 错误 4：端口冲突

**错误信息**：
```
bind: address already in use
```

**原因**：host 网络模式下，容器与宿主机共享端口

**解决方案**：
- 确保宿主机上的端口 80 和 8081 没有被其他服务占用
- 或者在 `.env` 文件中修改端口配置

### 8. 部署检查清单

在部署容器之前，请确保：

- [ ] 已确认宿主机上有可用的物理网卡（如 enp3s0, enp4s0 等）
- [ ] 已确认宿主机上存在 `/dev/ppp` 设备（`ls -la /dev/ppp`）
- [ ] 已在 docker-compose.yml 中配置 `network_mode: "host"`
- [ ] 已在 docker-compose.yml 中映射 `/dev/ppp` 设备
- [ ] 已在 docker-compose.yml 中添加 `NET_ADMIN` 和 `SYS_ADMIN` 权限
- [ ] 已在 docker-compose.yml 中设置 `privileged: true`
- [ ] 已在 `.env` 或 `config.py` 中配置正确的网卡名称
- [ ] 已确认端口 80 和 8081 没有被其他服务占用
- [ ] 已创建持久化存储目录（data, logs, instance）
- [ ] 已配置防火墙规则（如需要）

### 9. 验证部署

部署完成后，执行以下命令验证配置：

```bash
# 1. 检查容器是否运行
docker ps | grep pppoe-activation

# 2. 检查容器网络模式
docker inspect pppoe-activation | grep NetworkMode

# 3. 检查容器设备映射
docker inspect pppoe-activation | grep -A 5 Devices

# 4. 检查容器权限
docker inspect pppoe-activation | grep -A 5 CapAdd

# 5. 检查容器内 /dev/ppp 设备
docker exec pppoe-activation ls -la /dev/ppp

# 6. 检查容器内可用网卡
docker exec pppoe-activation ip link show

# 7. 测试用户激活页面
curl http://localhost:80/

# 8. 测试管理后台页面
curl http://localhost:8081/

# 9. 查看容器日志
docker logs pppoe-activation
```

### 10. 安全注意事项

使用 `host` 网络模式和 `privileged` 权限会降低容器的安全性，请务必：

1. **仅在内网环境使用**：不要将容器部署在公网环境
2. **修改默认密码**：首次登录后立即修改管理员密码
3. **限制访问权限**：使用防火墙限制对管理后台（端口 8081）的访问
4. **定期更新**：及时更新容器镜像和依赖包
5. **监控日志**：定期查看容器日志，发现异常及时处理
6. **备份数据**：定期备份数据库和日志文件

## 快速开始

### 1. 克隆或下载项目

```bash
cd /opt/pppoe-activation
# 或者
git clone <repository-url> /opt/pppoe-activation
cd /opt/pppoe-activation
```

### 2. 首次部署（使用 Web 配置界面）

#### 步骤 1：启动初始化配置服务

```bash
# 使用初始化配置服务
docker-compose --profile init up -d init-config
```

#### 步骤 2：打开浏览器配置

在浏览器中访问：http://localhost:9999

#### 步骤 3：配置网卡和持久化存储

在 Web 界面中：
1. 选择可用的网卡（系统会自动检测）
2. 配置应用端口和管理端口（默认都是 80）
3. 配置持久化存储路径（默认 ./data, ./logs, ./database.db, ./instance）
4. 配置时区（默认 Asia/Shanghai）
5. 点击"保存配置并重启"

#### 步骤 4：重启服务

配置保存后，在宿主机上执行：

```bash
# 停止初始化服务
docker-compose --profile init down

# 启动主服务
docker-compose up -d
```

#### 步骤 5：访问应用

**注意：由于使用 host 网络模式，需要指定端口号访问服务**

- 用户激活页面：http://localhost:80/ 或 http://ip:80/
- 管理后台页面：http://localhost:8081/ 或 http://ip:8081/

默认管理员账号：admin / admin123

### 3. 直接部署（跳过 Web 配置）

如果不想使用 Web 配置界面，可以直接配置：

#### 步骤 1：创建配置文件

```bash
# 复制示例配置文件
cp config.example.py config.py

# 编辑配置文件
nano config.py
```

修改网卡配置：
```python
# 根据实际情况修改网卡名称
NETWORK_INTERFACES = ['eth0', 'eth1', 'eth2', 'eth3']
```

#### 步骤 2：创建环境变量文件

```bash
# 复制示例环境变量文件
cp .env.example .env

# 编辑环境变量文件
nano .env
```

根据需要修改：
```bash
APP_PORT=80      # 应用端口（默认80）
ADMIN_PORT=80    # 管理端口（默认80）
NETWORK_INTERFACES=eth0 eth1 eth2 eth3
TZ=Asia/Shanghai
DATA_PATH=./data
LOGS_PATH=./logs
DB_PATH=./database.db
INSTANCE_PATH=./instance
```

#### 步骤 3：启动服务

```bash
docker-compose up -d
```

## 网卡配置

### 查看可用网卡

在宿主机上执行：

```bash
# 方法 1：使用 ip 命令
ip link show

# 方法 2：使用 ifconfig 命令
ifconfig

# 方法 3：在容器内查看
docker exec pppoe-activation ip link show
```

### 网卡命名规则

#### 传统命名
- eth0, eth1, eth2, eth3

#### 一致性命名（Consistent Interface Naming）
- enp3s0, enp4s0, enp5s0, enp6s0, enp7s0
- eno1, eno2, eno3

#### USB 网卡
- enx00e04c000000（以 enx 开头，后跟 MAC 地址）

#### 虚拟网卡
- docker0, docker1, ...
- br-xxxxxx（Docker 网桥）

### 配置示例

#### 示例 1：使用传统命名
```bash
NETWORK_INTERFACES=eth0 eth1 eth2 eth3
```

#### 示例 2：使用一致性命名
```bash
NETWORK_INTERFACES=enp3s0 enp4s0 enp5s0 enp6s0
```

#### 示例 3：混合使用
```bash
NETWORK_INTERFACES=eth0 enp4s0 enp5s0
```

## 持久化存储配置

### 默认配置

默认情况下，数据存储在项目根目录：

```
./data/           # 数据目录
./logs/           # 日志目录
./database.db     # 数据库文件
./instance/       # 实例目录
```

### 自定义存储路径

修改 `.env` 文件中的路径：

#### 示例 1：存储在 /data 目录

```bash
DATA_PATH=/data/pppoe-activation/data
LOGS_PATH=/data/pppoe-activation/logs
DB_PATH=/data/pppoe-activation/database.db
INSTANCE_PATH=/data/pppoe-activation/instance
```

#### 示例 2：存储在 /home/user/pppoe 目录

```bash
DATA_PATH=/home/user/pppoe/data
LOGS_PATH=/home/user/pppoe/logs
DB_PATH=/home/user/pppoe/database.db
INSTANCE_PATH=/home/user/pppoe/instance
```

#### 示例 3：存储在 NFS 共享目录

```bash
DATA_PATH=/mnt/nfs/pppoe-activation/data
LOGS_PATH=/mnt/nfs/pppoe-activation/logs
DB_PATH=/mnt/nfs/pppoe-activation/database.db
INSTANCE_PATH=/mnt/nfs/pppoe-activation/instance
```

### 目录权限设置

确保宿主机上的持久化目录具有正确的权限：

```bash
# 创建数据目录
mkdir -p data logs instance

# 设置权限（可选，根据需要调整）
chmod 755 data logs instance
```

### 验证持久化配置

#### 启动容器

```bash
docker-compose up -d
```

#### 检查挂载点

```bash
# 查看容器的挂载点
docker inspect pppoe-activation | grep -A 10 Mounts
```

#### 验证数据持久化

```bash
# 在容器内创建测试文件
docker exec pppoe-activation touch /opt/pppoe-activation/data/test.txt

# 检查宿主机上是否存在
ls -la ./data/
```

### 备份持久化数据

#### 手动备份

```bash
# 备份数据库
cp database.db database.db.backup.$(date +%Y%m%d_%H%M%S)

# 备份日志
tar -czf logs.backup.$(date +%Y%m%d_%H%M%S).tar.gz logs/

# 备份实例目录
tar -czf instance.backup.$(date +%Y%m%d_%H%M%S).tar.gz instance/
```

#### 自动备份脚本

创建 `backup.sh` 脚本：

```bash
#!/bin/bash

BACKUP_DIR="./backups"
DATE=$(date +%Y%m%d_%H%M%S)

mkdir -p $BACKUP_DIR

# 备份数据库
cp database.db $BACKUP_DIR/database.db.$DATE

# 备份日志
tar -czf $BACKUP_DIR/logs.$DATE.tar.gz logs/

# 备份实例目录
tar -czf $BACKUP_DIR/instance.$DATE.tar.gz instance/

# 保留最近 7 天的备份
find $BACKUP_DIR -name "*.db.*" -mtime +7 -delete
find $BACKUP_DIR -name "*.tar.gz" -mtime +7 -delete

echo "备份完成: $BACKUP_DIR"
```

设置定时任务（每天凌晨 2 点备份）：

```bash
# 编辑 crontab
crontab -e

# 添加以下行
0 2 * * * /path/to/backup.sh >> /var/log/pppoe-backup.log 2>&1
```

### 恢复持久化数据

#### 恢复数据库

```bash
# 停止容器
docker-compose down

# 恢复数据库
cp database.db.backup.20250119_020000 database.db

# 启动容器
docker-compose up -d
```

#### 恢复日志

```bash
# 停止容器
docker-compose down

# 恢复日志
tar -xzf logs.backup.20250119_020000.tar.gz -C ./

# 启动容器
docker-compose up -d
```

### 迁移持久化数据

如果需要将数据迁移到其他服务器：

```bash
# 在源服务器上打包数据
tar -czf pppoe-data.tar.gz data logs instance database.db

# 传输到目标服务器
scp pppoe-data.tar.gz user@target-server:/path/to/pppoe-activation/

# 在目标服务器上解压
cd /path/to/pppoe-activation
tar -xzf pppoe-data.tar.gz

# 启动容器
docker-compose up -d
```

### 监控磁盘空间

定期检查持久化目录的磁盘空间使用情况：

```bash
# 查看目录大小
du -sh data logs instance database.db

# 查看磁盘使用情况
df -h
```

### 清理旧日志

如果日志文件过多，可以定期清理：

```bash
# 清理 30 天前的日志
find logs -name "*.log" -mtime +30 -delete

# 清理空日志文件
find logs -name "*.log" -size 0 -delete
```

## 常用命令

### 启动服务

```bash
# 启动所有服务
docker-compose up -d

# 启动特定服务
docker-compose up -d pppoe-activation

# 启动并查看日志
docker-compose up -f
```

### 停止服务

```bash
# 停止所有服务
docker-compose down

# 停止并删除容器
docker-compose down

# 停止并删除容器和卷（慎用！）
docker-compose down -v
```

### 重启服务

```bash
# 重启所有服务
docker-compose restart

# 重启特定服务
docker-compose restart pppoe-activation
```

### 查看日志

```bash
# 查看所有日志
docker-compose logs

# 查看特定服务日志
docker-compose logs pppoe-activation

# 实时查看日志
docker-compose logs -f

# 实时查看特定服务日志
docker-compose logs -f pppoe-activation
```

### 进入容器

```bash
# 进入容器
docker exec -it pppoe-activation bash

# 在容器内执行命令
docker exec pppoe-activation ls -la /opt/pppoe-activation/

# 退出容器
exit
```

### 更新服务

```bash
# 重新构建镜像
docker-compose build

# 重新构建并启动
docker-compose up -d --build

# 强制重新构建（不使用缓存）
docker-compose build --no-cache
```

## 故障排查

### 问题 1：容器无法启动

**症状**：`docker-compose up -d` 后容器立即退出

**解决方法**：
```bash
# 查看容器日志
docker-compose logs

# 查看容器状态
docker ps -a

# 检查配置文件
cat config.py
cat .env
```

### 问题 2：无法访问 Web 界面

**症状**：浏览器无法打开 http://localhost/

**解决方法**：
```bash
# 检查容器是否运行
docker ps

# 检查端口映射
docker port pppoe-activation

# 检查防火墙
sudo ufw status
sudo firewall-cmd --list-all

# 检查服务日志
docker-compose logs pppoe-activation
```

### 问题 3：网卡不存在

**症状**：日志显示"接口 xxx 不存在"

**解决方法**：
```bash
# 在容器内查看可用网卡
docker exec pppoe-activation ip link show

# 在宿主机上查看可用网卡
ip link show

# 更新配置文件
nano config.py
# 或
nano .env

# 重启服务
docker-compose restart
```

### 问题 4：数据库丢失

**症状**：重启容器后数据丢失

**解决方法**：
```bash
# 检查挂载点
docker inspect pppoe-activation | grep -A 10 Mounts

# 检查宿主机文件
ls -la ./database.db
ls -la ./instance/

# 重新配置持久化存储
nano .env
docker-compose down
docker-compose up -d
```

### 问题 5：磁盘空间不足

**症状**：容器无法写入数据

**解决方法**：
```bash
# 检查磁盘空间
df -h

# 清理 Docker 缓存
docker system prune -a

# 清理日志
find logs -name "*.log" -mtime +30 -delete

# 清理旧备份
find . -name "*.backup.*" -mtime +7 -delete
```

## 性能优化

### 1. 使用更小的镜像

如果不需要图表功能，使用精简版依赖：

修改 [`Dockerfile`](Dockerfile:46) 第 46 行：
```dockerfile
COPY requirements.minimal.txt requirements.txt
```

### 2. 限制资源使用

在 [`docker-compose.yml`](docker-compose.yml:1) 中添加资源限制：

```yaml
services:
  pppoe-activation:
    # ... 其他配置 ...
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G
```

### 3. 使用外部数据库

如果需要更高的性能，可以使用外部数据库：

修改 `config.py`：
```python
# 使用外部 MySQL 数据库
DATABASE_PATH = 'mysql+pymysql://user:password@localhost/pppoe'
```

## 安全建议

### 1. 修改默认密码

首次登录后立即修改管理员密码：

1. 访问管理后台：http://localhost/dashboard
2. 登录（admin / admin123）
3. 修改密码

### 2. 配置防火墙

只开放必要的端口：

```bash
# Ubuntu/Debian
sudo ufw allow 80/tcp
sudo ufw enable

# CentOS/RHEL
sudo firewall-cmd --permanent --add-port=80/tcp
sudo firewall-cmd --reload
```

### 3. 使用 HTTPS

配置反向代理（Nginx）：

```nginx
server {
    listen 443 ssl;
    server_name your-domain.com;

    ssl_certificate /path/to/cert.pem;
    ssl_certificate_key /path/to/key.pem;

    location / {
        proxy_pass http://localhost:80;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

## 备份和恢复

### 备份

```bash
# 备份数据库
cp database.db database.db.backup.$(date +%Y%m%d_%H%M%S)

# 备份日志
tar -czf logs.backup.$(date +%Y%m%d_%H%M%S).tar.gz logs/

# 备份配置
tar -czf config.backup.$(date +%Y%m%d_%H%M%S).tar.gz config.py .env
```

### 恢复

```bash
# 停止服务
docker-compose down

# 恢复数据库
cp database.db.backup.20250119_020000 database.db

# 恢复日志
tar -xzf logs.backup.20250119_020000.tar.gz -C ./

# 启动服务
docker-compose up -d
```

## 升级

### 升级到新版本

```bash
# 1. 备份数据
cp database.db database.db.backup
tar -czf logs.backup.tar.gz logs/

# 2. 拉取新代码
git pull

# 3. 重新构建
docker-compose build

# 4. 重启服务
docker-compose up -d

# 5. 验证功能
curl http://localhost/
```

## 监控

### 查看容器状态

```bash
# 查看运行中的容器
docker ps

# 查看容器资源使用
docker stats

# 查看容器详细信息
docker inspect pppoe-activation
```

### 查看日志

```bash
# 查看应用日志
docker-compose logs -f pppoe-activation

# 查看特定时间段的日志
docker-compose logs --since 2025-01-19T00:00:00 pppoe-activation
```

## 总结

通过本指南，你应该能够：

✅ 成功部署 PPPOE 激活系统
✅ 配置网卡和持久化存储
✅ 解决常见问题
✅ 进行备份和恢复
✅ 升级到新版本
✅ 使用标准端口 80，无需指定端口号

如有问题，请查看：
- [`Docker优化说明.md`](Docker优化说明.md:1) - Docker 镜像优化说明
- [`持久化存储配置说明.md`](持久化存储配置说明.md:1) - 持久化存储配置说明
- 日志文件：`./logs/`
- 容器日志：`docker-compose logs pppoe-activation`
