# PPPOE 激活系统 - 容器部署指南

本指南说明如何在另一个服务器上部署已导出的PPPOE激活系统容器。

## 文件说明

- `pppoe-activation-image.tar` - Docker镜像文件（208MB）
- `pppoe-activation-container.tar` - 容器文件系统（196MB）

## 部署步骤

### 1. 上传文件到目标服务器

将以下文件上传到目标服务器：
```bash
scp pppoe-activation-image.tar user@target-server:/path/to/deploy/
scp pppoe-activation-container.tar user@target-server:/path/to/deploy/
```

### 2. 加载Docker镜像

在目标服务器上，加载Docker镜像：
```bash
docker load < pppoe-activation-image.tar
```

验证镜像是否加载成功：
```bash
docker images | grep pppoe-activation
```

### 3. 准备数据目录

创建数据持久化目录：
```bash
mkdir -p /opt/pppoe-activation/data
mkdir -p /opt/pppoe-activation/logs
mkdir -p /opt/pppoe-activation/instance
touch /opt/pppoe-activation/activation_log.jsonl
```

### 4. 启动主应用容器

使用host网络模式启动主应用容器：
```bash
docker run -d \
  --name pppoe-activation \
  --restart unless-stopped \
  --network host \
  -e TZ=Asia/Shanghai \
  -e APP_PORT=80 \
  -e ADMIN_PORT=8081 \
  -e NETWORK_INTERFACES=enp3s0 \
  -v /opt/pppoe-activation/data:/opt/pppoe-activation/data \
  -v /opt/pppoe-activation/logs:/opt/pppoe-activation/logs \
  -v /opt/pppoe-activation/instance:/opt/pppoe-activation/instance \
  -v /opt/pppoe-activation/activation_log.jsonl:/opt/pppoe-activation/activation_log.jsonl \
  --cap-add NET_ADMIN \
  --cap-add SYS_ADMIN \
  --device /dev/net/tun \
  --security-opt seccomp:unconfined \
  --privileged \
  pppoe-activation:latest
```

### 5. 启动配置服务容器

使用host网络模式启动配置服务容器：
```bash
docker run -d \
  --name pppoe-init \
  --network host \
  -v /opt/pppoe-activation/config.py:/opt/pppoe-activation/config.py \
  -v /opt/pppoe-activation/.env:/opt/pppoe-activation/.env \
  -v /opt/pppoe-activation/templates:/opt/pppoe-activation/templates \
  -v /var/run/docker.sock:/var/run/docker.sock \
  --entrypoint python3 \
  pppoe-activation:latest \
  init_config.py
```

### 6. 验证容器状态

检查容器是否正常运行：
```bash
docker ps -a | grep pppoe
```

应该看到两个容器都处于"Up (healthy)"状态。

### 7. 访问服务

- 用户激活页面：http://服务器IP:80/
- 管理后台页面：http://服务器IP:8081/dashboard
- 配置服务页面：http://服务器IP:9999/

### 8. 配置系统

访问配置服务页面（http://服务器IP:9999/），配置以下内容：

1. **网卡配置**：选择用于PPPOE拨号的网卡
   - 可以选择多个网卡
   - 包括状态为"DOWN"的网卡
   - 查看网卡状态和IP地址

2. **端口配置**：
   - 应用端口：默认80
   - 管理端口：默认8081

3. **持久化存储配置**：
   - 数据库文件路径：./instance/database.db
   - 日志目录路径：./logs
   - 数据目录路径：./data

4. **时区配置**：
   - 默认：Asia/Shanghai

点击"保存配置并重启"按钮，系统会自动重启主应用容器。

### 9. 测试PPPOE拨号

访问用户激活页面（http://服务器IP:80/），填写以下信息：

1. 姓名
2. 职业（学生/教职工/外包）
3. 运营商（校园网/移动/电信/联通）
4. 账号
5. 密码

点击"激活账号"按钮，系统会自动进行PPPOE拨号测试。

## 常见问题

### 1. 容器无法启动

检查容器日志：
```bash
docker logs pppoe-activation
docker logs pppoe-init
```

### 2. 端口无法访问

检查端口是否被占用：
```bash
netstat -tlnp | grep :80
netstat -tlnp | grep :8081
```

检查防火墙规则：
```bash
sudo iptables -L -n -v | grep -E "(80|8081)"
```

### 3. 数据持久化不生效

检查挂载点：
```bash
docker inspect pppoe-activation | grep -A 20 "Mounts"
```

### 4. PPPOE拨号失败

检查网卡状态：
```bash
ip link show
ip addr show
```

检查日志文件：
```bash
ls -la /opt/pppoe-activation/logs/
cat /opt/pppoe-activation/logs/pppoe_*.log
```

## 容器管理命令

### 查看容器状态
```bash
docker ps -a | grep pppoe
```

### 查看容器日志
```bash
docker logs -f pppoe-activation
docker logs -f pppoe-init
```

### 重启容器
```bash
docker restart pppoe-activation
docker restart pppoe-init
```

### 停止容器
```bash
docker stop pppoe-activation
docker stop pppoe-init
```

### 删除容器
```bash
docker stop pppoe-activation pppoe-init
docker rm pppoe-activation pppoe-init
```

### 更新容器

1. 停止并删除旧容器
2. 加载新的Docker镜像
3. 使用相同的命令启动新容器

## 注意事项

1. **网络模式**：使用host网络模式，容器可以直接访问宿主机的网络接口
2. **权限**：容器以root用户身份运行，可以执行PPPOE拨号操作
3. **数据持久化**：所有数据目录都挂载到宿主机上，容器重启后数据不会丢失
4. **健康检查**：容器会定期检查服务状态，确保服务正常运行
5. **自动重启**：容器配置为`unless-stopped`，如果容器意外退出会自动重启

## 默认账号

- 管理后台用户名：admin
- 管理后台密码：admin123

**重要**：首次登录后请立即修改默认密码！

## 技术支持

如有问题，请检查：
1. 容器日志：`docker logs pppoe-activation`
2. 系统日志：`journalctl -u docker`
3. 网络配置：`ip link show`, `ip addr show`
4. 防火墙规则：`sudo iptables -L -n -v`
