# PPPOE 激活系统 - 镜像拉取更新指南

本文档说明如何拉取和更新 PPPOE 激活系统的 Docker 镜像。

## 目录

1. [从 Docker Hub 拉取镜像](#从-docker-hub-拉取镜像)
2. [更新现有镜像](#更新现有镜像)
3. [验证镜像版本](#验证镜像版本)
4. [重启容器应用新镜像](#重启容器应用新镜像)
5. [常见问题](#常见问题)

## 从 Docker Hub 拉取镜像

### 拉取最新版本

```bash
# 拉取最新版本镜像
docker pull scerp/pppoe-activation:latest

# 查看已拉取的镜像
docker images | grep pppoe-activation
```

### 拉取指定版本

```bash
# 拉取指定版本镜像
docker pull scerp/pppoe-activation:v3.1.2

# 查看已拉取的镜像
docker images | grep pppoe-activation
```

### 可用版本列表

| 版本 | 发布日期 | 主要更新 |
|------|----------|----------|
| v3.1.2 | 2026-02-03 | 修复容器启动参数说明 |
| v3.1.1 | 2026-02-03 | 修复 VLAN 子接口创建问题 |
| v3.1.0 | 2026-02-02 | 添加 11 语言多语言支持 |
| v3.0.2 | 2026-02-01 | 修复配置读取问题 |

## 更新现有镜像

### 方法 1：自动更新（推荐）

```bash
# 1. 停止并删除旧容器
docker stop pppoe-activation
docker rm pppoe-activation

# 2. 拉取最新镜像
docker pull scerp/pppoe-activation:latest

# 3. 重新启动容器（使用正确的启动参数）
docker run -d --name pppoe-activation \
  --restart=unless-stopped \
  --device=/dev/ppp \
  --cap-add=NET_ADMIN \
  --cap-add=NET_RAW \
  -p 80:80 \
  -p 8081:8081 \
  -p 9999:9999 \
  -v $(pwd)/logs:/opt/pppoe-activation/logs \
  -v $(pwd)/data:/opt/pppoe-activation/data \
  -v $(pwd)/instance:/opt/pppoe-activation/instance \
  --network=host \
  scerp/pppoe-activation:latest

# 4. 验证容器状态
docker ps | grep pppoe-activation
```

### 方法 2：保留数据更新（推荐用于生产环境）

```bash
# 1. 拉取最新镜像
docker pull scerp/pppoe-activation:latest

# 2. 停止旧容器
docker stop pppoe-activation

# 3. 备份数据（可选但推荐）
tar -czf pppoe-backup-$(date +%Y%m%d_%H%M%S).tar.gz logs/ instance/ data/

# 4. 删除旧容器
docker rm pppoe-activation

# 5. 启动新容器
docker run -d --name pppoe-activation \
  --restart=unless-stopped \
  --device=/dev/ppp \
  --cap-add=NET_ADMIN \
  --cap-add=NET_RAW \
  -p 80:80 \
  -p 8081:8081 \
  -p 9999:9999 \
  -v $(pwd)/logs:/opt/pppoe-activation/logs \
  -v $(pwd)/data:/opt/pppoe-activation/data \
  -v $(pwd)/instance:/opt/pppoe-activation/instance \
  --network=host \
  scerp/pppoe-activation:latest

# 6. 验证容器状态
docker ps | grep pppoe-activation

# 7. 查看启动日志
docker logs pppoe-activation
```

## 验证镜像版本

### 查看镜像版本信息

```bash
# 方法 1：查看镜像列表
docker images | grep pppoe-activation

# 方法 2：查看镜像详细信息
docker inspect scerp/pppoe-activation:latest | grep -A 5 "Labels"

# 方法 3：查看容器内的 VERSION 文件
docker exec pppoe-activation cat /opt/pppoe-activation/VERSION
```

### 验证容器功能

```bash
# 1. 检查容器状态
docker ps | grep pppoe-activation

# 2. 检查 /dev/ppp 设备
docker exec pppoe-activation ls -l /dev/ppp

# 3. 检查 pppd 命令
docker exec pppoe-activation which pppd

# 4. 检查 PPPoE 插件
docker exec pppoe-activation ls -la /usr/lib/pppd/*/rp-pppoe.so

# 5. 访问 Web 界面
curl -I http://localhost:80/
```

## 重启容器应用新镜像

### 重启容器

```bash
# 重启容器
docker restart pppoe-activation

# 查看重启后状态
docker ps | grep pppoe-activation

# 查看重启日志
docker logs pppoe-activation
```

### 验证服务可用性

```bash
# 测试用户激活页面
curl http://localhost:80/

# 测试管理后台
curl http://localhost:8081/

# 测试配置管理页面
curl http://localhost:9999/
```

## 常见问题

### 1. 镜像拉取失败

**问题**：无法从 Docker Hub 拉取镜像

**解决方法**：

```bash
# 检查网络连接
ping docker.io

# 检查 Docker 服务状态
sudo systemctl status docker

# 重启 Docker 服务
sudo systemctl restart docker

# 重新拉取镜像
docker pull scerp/pppoe-activation:latest
```

### 2. 容器启动失败

**问题**：容器启动后立即退出

**解决方法**：

```bash
# 查看容器日志
docker logs pppoe-activation

# 检查 /dev/ppp 设备
ls -l /dev/ppp

# 检查容器启动参数
docker inspect pppoe-activation --format='{{json .HostConfig}}' | python3 -m json.tool | grep -E "Devices|CapAdd"
```

**必需的启动参数**：
- `--device=/dev/ppp`
- `--cap-add=NET_ADMIN`
- `--cap-add=NET_RAW`

### 3. PPPoE 拨号失败

**问题**：拨号失败，日志显示"Couldn't open the /dev/ppp device"

**解决方法**：

```bash
# 1. 检查容器启动参数
docker inspect pppoe-activation --format='{{json .HostConfig.Devices}}' | python3 -m json.tool

# 2. 如果缺少 --device=/dev/ppp，重新启动容器
docker stop pppoe-activation
docker rm pppoe-activation
docker run -d --name pppoe-activation \
  --restart=unless-stopped \
  --device=/dev/ppp \
  --cap-add=NET_ADMIN \
  --cap-add=NET_RAW \
  --network=host \
  scerp/pppoe-activation:latest

# 3. 验证 /dev/ppp 设备
docker exec pppoe-activation ls -l /dev/ppp
```

### 4. 数据丢失

**问题**：更新后数据丢失

**解决方法**：

```bash
# 1. 检查持久化目录
ls -la logs/ instance/ data/

# 2. 检查容器挂载
docker inspect pppoe-activation | grep Mounts

# 3. 如果数据丢失，从备份恢复
./restore.sh /path/to/backup
```

### 5. 版本不兼容

**问题**：新版本与旧版本配置不兼容

**解决方法**：

```bash
# 1. 备份数据
tar -czf pppoe-backup-$(date +%Y%m%d_%H%M%S).tar.gz logs/ instance/ data/

# 2. 删除旧容器
docker stop pppoe-activation
docker rm pppoe-activation

# 3. 重新初始化配置
docker run -d --name pppoe-activation \
  --restart=unless-stopped \
  --device=/dev/ppp \
  --cap-add=NET_ADMIN \
  --cap-add=NET_RAW \
  -p 80:80 \
  -p 8081:8081 \
  -p 9999:9999 \
  -v $(pwd)/logs:/opt/pppoe-activation/logs \
  -v $(pwd)/data:/opt/pppoe-activation/data \
  -v $(pwd)/instance:/opt/pppoe-activation/instance \
  --network=host \
  scerp/pppoe-activation:latest

# 4. 访问配置管理页面重新配置
# http://服务器IP:9999
```

## 更新日志

### v3.1.2 (2026-02-03)

- 修复容器启动参数说明
- 添加 `--cap-add=NET_RAW` 参数说明
- 优化部署指南文档

### v3.1.1 (2026-02-03)

- 修复 VLAN 子接口创建问题
- 优化容器启动脚本
- 添加更详细的错误日志

### v3.1.0 (2026-02-02)

- 添加 11 语言多语言支持
- 优化前端界面
- 添加默认密码填充功能

## 下一步

更新完成后，建议：

1. 验证所有功能正常
2. 测试 PPPoE 拨号功能
3. 检查日志是否正常写入
4. 备份重要数据

## 获取帮助

如果遇到问题：

1. 查看容器日志：`docker logs pppoe-activation`
2. 查看部署指南：[`部署指南-全新宿主机.md`](部署指南-全新宿主机.md)
3. 查看备份恢复指南：[`BACKUP_README.md`](BACKUP_README.md)
4. 访问 GitHub Issues：https://github.com/hicool-ml/pppoe-activation/issues
